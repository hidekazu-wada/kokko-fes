---
// コンポーネント
import PageLayout from "../../layouts/PageLayout.astro";
import PageBottomWave from "../../components/common/PageBottomWave.astro";
import Breadcrumb from "../../components/common/Breadcrumb.astro";
import PageTitle from "../../components/common/PageTitle.astro";

// データとタイプ
import newsData from "../../data/news.json";
import type { NewsData, NewsArticle, NewsCategory } from "../../types/news.ts";

// 開発用の静的パス設定
export async function getStaticPaths() {
  const typedNewsData = newsData as NewsData;
  return typedNewsData.articles.map((article) => ({
    params: { slug: article.slug },
  }));
}

// 画像
import { getImage } from "astro:assets";
import DemoImage from "../../images/news-detail/demo.png";

// フォーマット
const Demo = await getImage({
  src: DemoImage,
  format: "webp", // WebP形式で最適化
  widths: [560, 900, 1400],
});

// データ取得
const { slug } = Astro.params;
const typedNewsData = newsData as NewsData;
const article = typedNewsData.articles.find((a) => a.slug === slug);
const category = typedNewsData.categories.find(
  (c) => c.id === article?.category,
);

// 記事が見つからない場合の処理
if (!article) {
  throw new Error(`Article not found for slug: ${slug}`);
}

// 前後の記事を取得
const currentIndex = typedNewsData.articles.findIndex((a) => a.slug === slug);
const prevArticle =
  currentIndex > 0 ? typedNewsData.articles[currentIndex - 1] : null;
const nextArticle =
  currentIndex < typedNewsData.articles.length - 1
    ? typedNewsData.articles[currentIndex + 1]
    : null;
---

<PageLayout
  title={`${article.title} ｜コッコ祭り 2025｜KOKKO Festival`}
  description={article.excerpt || `コッコ祭り2025のお知らせ「${article.title}」。最新のイベント情報をお届けします。`}
>
  <!-- news detail content -->
  <section class="page-wrapper news-detail">
    <div class="news-detail__container">
      <PageTitle accent="お" title="知らせ" subtitle="NEWS" />
      <article class="news-article">
        <header class="news-article__header">
          <div class="news-article__category">
            <span>{category?.name}</span>
          </div>
        </header>
        <time class="news-article__date" datetime={article.publishedAt}
          >{article.publishedAt}</time
        >
        <section class="news-article__content">
          <h2 class="news-article__title">
            {article.title}
          </h2>
          <span class="news-article__divider"></span>
          <main class="news-article__body" set:html={article.content} />
        </section>

        <nav class="news-navigation">
          {
            prevArticle && (
              <a
                href={`/news/${prevArticle.slug}/`}
                class="news-navigation__prev"
              >
                <div class="news-navigation__icon-wrapper">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="56"
                    height="56"
                    viewBox="0 0 56 56"
                    fill="none"
                    class="news-navigation__icon"
                  >
                    <circle
                      cx="28"
                      cy="28"
                      r="28"
                      transform="matrix(-1 0 0 1 56 0)"
                      fill="#C99E2D"
                    />
                    <path
                      d="M32.8662 18.2559L33.8976 19.7598L34.8304 21.2894L33.2774 22.3003L31.6896 23.3447L30.1227 24.4145L28.5349 25.459L26.9018 26.4304L25.278 27.5369L26.9909 28.5094L28.5348 29.6429L30.1415 30.665L31.7451 31.7046L33.3299 32.7696L35.0033 33.782L33.8958 35.2908L32.9647 36.9102L31.4062 35.7561L29.8106 34.7324L28.146 33.8154L26.6416 32.642L24.9958 31.6995L23.4081 30.6519L21.8409 29.59L20.2201 28.587L18.6417 27.5267L20.2701 26.5617L21.7741 25.4157L23.4251 24.4872L24.9228 23.3365L26.5883 22.4286L28.1295 21.3398L29.6835 20.2605L31.2909 19.2701L32.8662 18.2559Z"
                      fill="#FFFCF2"
                    />
                  </svg>
                  <span class="news-navigation__label">前の記事</span>
                </div>
                <p class="news-navigation__title">{prevArticle.title}</p>
              </a>
            )
          }

          {
            nextArticle && (
              <a
                href={`/news/${nextArticle.slug}/`}
                class="news-navigation__next"
              >
                <div class="news-navigation__icon-wrapper">
                  <span class="news-navigation__label">次の記事</span>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="56"
                    height="56"
                    viewBox="0 0 56 56"
                    fill="none"
                    class="news-navigation__icon"
                  >
                    <circle cx="28" cy="28" r="28" fill="#C99E2D" />
                    <path
                      d="M23.1338 18.2559L22.1024 19.7598L21.1696 21.2894L22.7226 22.3003L24.3104 23.3447L25.8773 24.4145L27.4651 25.459L29.0982 26.4304L30.722 27.5369L29.0091 28.5094L27.4652 29.6429L25.8585 30.665L24.2549 31.7046L22.6701 32.7696L20.9967 33.782L22.1042 35.2908L23.0353 36.9102L24.5938 35.7561L26.1894 34.7324L27.854 33.8154L29.3584 32.642L31.0042 31.6995L32.5919 30.6519L34.1591 29.59L35.7799 28.587L37.3583 27.5267L35.7299 26.5617L34.2259 25.4157L32.5749 24.4872L31.0772 23.3365L29.4117 22.4286L27.8705 21.3398L26.3165 20.2605L24.7091 19.2701L23.1338 18.2559Z"
                      fill="#FFFCF2"
                    />
                  </svg>
                </div>
                <p class="news-navigation__title">{nextArticle.title}</p>
              </a>
            )
          }
        </nav>
      </article>

      <!-- ここにお知らせ詳細のマークアップを追加 -->
    </div>
    <Breadcrumb
      currentPageTitle={article.title}
      parentPage={{ title: "お知らせ", href: "/news/" }}
    />
    <PageBottomWave />
  </section>
</PageLayout>

<script>
  // お知らせ詳細ページのJavaScript
  document.addEventListener("DOMContentLoaded", () => {
    // ナビゲーションタイトルの文字数制限
    const navigationTitles = document.querySelectorAll(
      ".news-navigation__title",
    );

    navigationTitles.forEach((titleElement) => {
      const originalText = titleElement.textContent || "";
      const maxLength = 23; // 最大文字数

      if (originalText.length > maxLength) {
        const truncatedText = originalText.substring(0, maxLength) + "...";
        titleElement.textContent = truncatedText;
      }
    });
  });
</script>

<style lang="scss">
  @import "../../styles/variables";
  @import "../../styles/functions";
  @import "../../styles/mixins";

  .news-detail {
    padding-top: spx(296);
    position: relative;
    min-height: 90vh;
    padding-bottom: spx(99);
    @include tablet-up {
      padding-top: ppx(253 * 1.2);
      padding-bottom: ppx(228 * 1.2);
    }
    @include desktop-up {
      padding-top: ppx(253);
      padding-bottom: ppx(228);
    }

    &__container {
      padding-bottom: spx(100);
      @include tablet-up {
        padding-bottom: ppx(130 * 1.2);
      }
      @include desktop-up {
        padding-bottom: ppx(130);
      }
    }
  }

  .news-article {
    margin-top: spx(80);
    @include tablet-up {
      margin-top: ppx(81 * 1.2);
    }
    @include desktop-up {
      margin-top: ppx(81);
    }

    &__header {
      @include tablet-up {
      }
      @include desktop-up {
      }
    }

    &__category {
      display: flex;
      padding-bottom: spx(4);
      justify-content: center;
      align-items: center;
      gap: spx(10);
      border-radius: spx(15);
      background: var(--logo_color_3, #c99e2d);
      width: spx(220);
      margin-inline: auto;
      @include tablet-up {
        padding-bottom: ppx(4 * 1.2);
        gap: ppx(10 * 1.2);
        border-radius: ppx(15 * 1.2);
        width: ppx(220 * 1.2);
      }
      @include desktop-up {
        padding-bottom: ppx(4);
        gap: ppx(10);
        border-radius: ppx(15);
        width: ppx(220);
      }
      span {
        color: var(--base_1, #fffcf2);
        text-align: center;
        font-size: spx(26);
        font-weight: 700;
        line-height: 180%;
        @include tablet-up {
          font-size: ppx(28 * 1.2);
        }
        @include desktop-up {
          font-size: ppx(28);
        }
      }
    }

    &__date {
      display: block;
      color: var(--base_5, #102a4d);
      font-size: spx(30);
      font-weight: 700;
      line-height: 160%;
      margin-top: spx(24);
      text-align: center;
      @include tablet-up {
        font-size: ppx(30 * 1.2);
        line-height: 180%;
        margin-top: ppx(30 * 1.2);
      }
      @include desktop-up {
        font-size: ppx(30);
        line-height: 180%;
        margin-top: ppx(24);
      }
    }

    &__content {
      display: block;
      width: spx(640);
      margin-inline: auto;
      margin-top: spx(30);
      padding: spx(40) spx(30) spx(80) spx(30);
      border-radius: spx(30);
      background: var(--white, #fff);

      @include tablet-up {
        width: ppx(1600 * 1.2);
        padding: ppx(80 * 1.2) ppx(100 * 1.2) ppx(120 * 1.2) ppx(100 * 1.2);
        gap: ppx(40 * 1.2);
        border-radius: ppx(40 * 1.2);
        margin-top: ppx(30 * 1.2);
      }
      @include desktop-up {
        width: ppx(1600);
        padding: ppx(80) ppx(100) ppx(120) ppx(100);
        gap: ppx(40);
        border-radius: ppx(40);
        margin-top: ppx(30);
      }
    }

    &__title {
      color: #c99e2d;
      font-size: spx(33);
      font-weight: 700;
      line-height: 160%;
      letter-spacing: spx(-0.33);
      @include tablet-up {
        text-align: center;
        font-size: ppx(40 * 1.2);
      }
      @include desktop-up {
        font-size: ppx(40);
      }
    }

    &__divider {
      display: block;
      background: linear-gradient(
          to right,
          #102a4d,
          #102a4d 25%,
          rgba(0, 0, 0, 0) 25%,
          rgba(0, 0, 0, 0) 100%
        )
        0% 0%;
      background-size: 4px 1px;
      width: 100%;
      height: 1px;
      margin-left: auto;
      margin-right: auto;
      margin-top: spx(20);
      margin-bottom: spx(20);
      @include tablet-up {
        margin-top: ppx(40 * 1.2);
        margin-bottom: ppx(40 * 1.2);
      }
      @include desktop-up {
        margin-top: ppx(40);
        margin-bottom: ppx(40);
      }
    }

    &__body {
      color: var(--base_5, #102a4d);
      font-size: spx(30);
      font-weight: 700;
      line-height: 180%;
      @include tablet-up {
        font-size: ppx(33 * 1.2);
      }
      @include desktop-up {
        font-size: ppx(33);
      }
      section {
        margin-top: spx(20);
        @include tablet-up {
          margin-top: ppx(40 * 1.2);
        }
        @include desktop-up {
          margin-top: ppx(40);
        }
      }
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-weight: 900;
        @include tablet-up {
        }
        @include desktop-up {
        }
      }
    }
  }

  .news-navigation {
    display: grid;
    grid-template:
      "prev next"
      / spx(258) spx(258);
    gap: spx(30);
    justify-content: center;
    margin-top: spx(30);
    @include tablet-up {
      gap: ppx(60 * 1.2);
      margin-top: ppx(50 * 1.2);
      grid-template:
        "prev next"
        / ppx(770 * 1.2) ppx(770 * 1.2);
    }
    @include desktop-up {
      gap: ppx(60);
      margin-top: ppx(50);
      grid-template:
        "prev next"
        / ppx(770) ppx(770);
    }

    &__prev {
      grid-area: prev;
      display: flex;
      padding: spx(20) spx(40);
      align-items: center;
      gap: spx(16);
      border-radius: spx(20);
      background: var(--base_2, #fcf2c9);
      width: spx(258);
      transition:
        background-color 0.3s ease,
        transform 0.2s ease;
      text-decoration: none;
      @include tablet-up {
        width: ppx(770 * 1.2);
        padding: ppx(40 * 1.2) ppx(50 * 1.2);
        flex-direction: column;
        align-items: flex-start;
        gap: ppx(15 * 1.2);
        flex-shrink: 0;
        border-radius: ppx(40 * 1.2);
        width: ppx(770 * 1.2);
      }
      @include desktop-up {
        width: ppx(770);
        padding: ppx(40) ppx(50);
        flex-direction: column;
        align-items: flex-start;
        gap: ppx(15);
        flex-shrink: 0;
        border-radius: ppx(40);
        width: ppx(770);
      }

      @include hover {
        &:hover {
          background: var(--white, #fff);
          transform: translateY(-2px);
        }
      }
    }

    &__next {
      grid-area: next;
      display: flex;
      padding: spx(20) spx(40);
      align-items: center;
      gap: spx(16);
      border-radius: spx(20);
      background: var(--base_2, #fcf2c9);
      width: spx(258);
      transition:
        background-color 0.3s ease,
        transform 0.2s ease;
      text-decoration: none;
      @include tablet-up {
        width: ppx(770 * 1.2);
        padding: ppx(40 * 1.2) ppx(50 * 1.2);
        flex-direction: column;
        gap: ppx(15 * 1.2);
        flex-shrink: 0;
        border-radius: ppx(40 * 1.2);
        width: ppx(770 * 1.2);
        align-items: flex-end;
      }
      @include desktop-up {
        width: ppx(770);
        padding: ppx(40) ppx(50);
        flex-direction: column;
        gap: ppx(15);
        flex-shrink: 0;
        border-radius: ppx(40);
        width: ppx(770);
      }
      .news-navigation__icon-wrapper {
        margin-left: auto;
        margin-right: 0;
        @include tablet-up {
          // タブレット用スタイル
        }
        @include desktop-up {
          // デスクトップ用スタイル
        }
      }

      @include hover {
        &:hover {
          background: var(--white, #fff);
          transform: translateY(-2px);
        }
      }
    }

    &__icon-wrapper {
      display: flex;
      align-items: center;
      gap: spx(16);
      @include tablet-up {
        gap: ppx(16 * 1.2);
      }
      @include desktop-up {
        gap: ppx(16);
      }
    }

    &__icon {
      display: block;
      width: spx(50);
      height: spx(50);
      @include tablet-up {
        width: ppx(56 * 1.2);
        height: ppx(56 * 1.2);
      }
      @include desktop-up {
        width: ppx(56);
        height: ppx(56);
      }
    }

    &__label {
      color: var(--logo_color_3, #c99e2d);
      font-size: spx(28);
      font-weight: 500;
      line-height: 100%;
      @include tablet-up {
        font-size: ppx(30 * 1.2);
      }
      @include desktop-up {
        font-size: ppx(30);
      }
    }

    &__title {
      display: none;
      @include tablet-up {
        display: block;
        color: var(--base_5, #102a4d);
        font-size: ppx(30 * 1.2);
        font-weight: 500;
        line-height: 150%;
      }
      @include desktop-up {
        font-size: ppx(30);
      }
    }
  }
</style>
