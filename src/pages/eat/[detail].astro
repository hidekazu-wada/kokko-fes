---
// コンポーネント
import PageLayout from "../../layouts/PageLayout.astro";
import PageBottomWave from "../../components/common/PageBottomWave.astro";
import Breadcrumb from "../../components/common/Breadcrumb.astro";

// データ
import categoriesData from "../../data/categories.json";

// 画像
import Demo from "../../images/eat/demo.png";

// フォーマット
import { getImage } from "astro:assets";
const DemoImage = await getImage({
  src: Demo,
  format: "webp",
  widths: [87, 170, 620, 900, 1400],
});

// 型定義
interface CategoryItem {
  name: string;
  image: string;
  location: string;
  time: string;
}

interface CategoryData {
  id: string;
  title: string;
  titleAccent: string;
  subtitle: string;
  description: string;
  items: CategoryItem[];
}

interface CategoriesData {
  [key: string]: CategoryData;
}

export async function getStaticPaths() {
  const typedCategoriesData = categoriesData as CategoriesData;
  const categoryData = typedCategoriesData.eat;

  const paths: any[] = [];

  // eatカテゴリーのアイテムごとに詳細ページのパスを生成
  categoryData.items.forEach((item: CategoryItem) => {
    const detailSlug = item.name.toLowerCase().replace(/\s+/g, "-");

    paths.push({
      params: {
        detail: detailSlug,
      },
      props: {
        categoryData,
        itemData: item,
        categoryId: "eat",
      },
    });
  });

  return paths;
}

const { categoryData, itemData, categoryId } = Astro.props;
const { detail } = Astro.params;
---

<PageLayout
  title={`${itemData.name} | ${categoryData.title} ｜コッコ祭り 2025｜KOKKO Festival`}
>
  <section class="page-wrapper detail-page">
    <div class="detail-page__container">
      <header class="detail-page__header">
        <h1 class="detail-page__title">
          <span class="detail-page__title-accent">見</span>
          る
        </h1>
        <p class="detail-page__subtitle">− WATCH −</p>
      </header>

      <main class="detail-content">
        <header class="detail-content__header">
          <h2 class="detail-content__title">和太鼓演奏</h2>
          <p class="detail-content__description">
            地域の伝統工芸品を一堂に集めた特別展示。職人による実演も行われます。
          </p>
        </header>

        <section class="detail-content__media">
          <div class="detail-content__main-image swiper" id="main-swiper">
            <div class="swiper-wrapper">
              <div class="swiper-slide">
                <figure class="detail-content__main-figure">
                  <picture>
                    <!-- デスクトップ（1024px以上）→ 最高解像度版 -->
                    <source
                      media="(min-width: 1024px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <!-- タブレット（744px以上）→ 中解像度版 -->
                    <source
                      media="(min-width: 744px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <!-- スマホ（744px未満）→ 最小解像度版 -->
                    <img
                      src={DemoImage.src}
                      alt="メインビジュアル"
                      class="detail-content__main-img"
                    />
                  </picture>
                </figure>
              </div>
              <div class="swiper-slide">
                <figure class="detail-content__main-figure">
                  <picture>
                    <source
                      media="(min-width: 1024px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <source
                      media="(min-width: 744px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <img
                      src={DemoImage.src}
                      alt="メインビジュアル"
                      class="detail-content__main-img"
                    />
                  </picture>
                </figure>
              </div>
              <div class="swiper-slide">
                <figure class="detail-content__main-figure">
                  <picture>
                    <source
                      media="(min-width: 1024px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <source
                      media="(min-width: 744px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <img
                      src={DemoImage.src}
                      alt="メインビジュアル"
                      class="detail-content__main-img"
                    />
                  </picture>
                </figure>
              </div>
              <div class="swiper-slide">
                <figure class="detail-content__main-figure">
                  <picture>
                    <source
                      media="(min-width: 1024px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <source
                      media="(min-width: 744px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <img
                      src={DemoImage.src}
                      alt="メインビジュアル"
                      class="detail-content__main-img"
                    />
                  </picture>
                </figure>
              </div>
              <div class="swiper-slide">
                <figure class="detail-content__main-figure">
                  <picture>
                    <source
                      media="(min-width: 1024px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <source
                      media="(min-width: 744px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <img
                      src={DemoImage.src}
                      alt="メインビジュアル"
                      class="detail-content__main-img"
                    />
                  </picture>
                </figure>
              </div>
              <div class="swiper-slide">
                <figure class="detail-content__main-figure">
                  <picture>
                    <source
                      media="(min-width: 1024px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <source
                      media="(min-width: 744px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <img
                      src={DemoImage.src}
                      alt="メインビジュアル"
                      class="detail-content__main-img"
                    />
                  </picture>
                </figure>
              </div>
            </div>
          </div>

          <nav class="detail-content__thumbnails swiper" id="thumb-swiper">
            <div class="swiper-wrapper">
              <div class="swiper-slide">
                <figure class="detail-content__thumbnail">
                  <picture>
                    <!-- デスクトップ（1024px以上）→ 最高解像度版 -->
                    <source
                      media="(min-width: 1024px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <!-- タブレット（744px以上）→ 中解像度版 -->
                    <source
                      media="(min-width: 744px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <!-- スマホ（744px未満）→ 最小解像度版 -->
                    <img
                      src={DemoImage.src}
                      alt="サムネ"
                      class="detail-content__thumbnail-img"
                    />
                  </picture>
                </figure>
              </div>
              <div class="swiper-slide">
                <figure class="detail-content__thumbnail">
                  <picture>
                    <source
                      media="(min-width: 1024px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <source
                      media="(min-width: 744px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <img
                      src={DemoImage.src}
                      alt="サムネ"
                      class="detail-content__thumbnail-img"
                    />
                  </picture>
                </figure>
              </div>
              <div class="swiper-slide">
                <figure class="detail-content__thumbnail">
                  <picture>
                    <source
                      media="(min-width: 1024px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <source
                      media="(min-width: 744px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <img
                      src={DemoImage.src}
                      alt="サムネ"
                      class="detail-content__thumbnail-img"
                    />
                  </picture>
                </figure>
              </div>
              <div class="swiper-slide">
                <figure class="detail-content__thumbnail">
                  <picture>
                    <source
                      media="(min-width: 1024px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <source
                      media="(min-width: 744px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <img
                      src={DemoImage.src}
                      alt="サムネ"
                      class="detail-content__thumbnail-img"
                    />
                  </picture>
                </figure>
              </div>
              <div class="swiper-slide">
                <figure class="detail-content__thumbnail">
                  <picture>
                    <source
                      media="(min-width: 1024px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <source
                      media="(min-width: 744px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <img
                      src={DemoImage.src}
                      alt="サムネ"
                      class="detail-content__thumbnail-img"
                    />
                  </picture>
                </figure>
              </div>
              <div class="swiper-slide">
                <figure class="detail-content__thumbnail">
                  <picture>
                    <source
                      media="(min-width: 1024px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <source
                      media="(min-width: 744px)"
                      srcset={DemoImage.srcSet.toString()}
                    />
                    <img
                      src={DemoImage.src}
                      alt="サムネ"
                      class="detail-content__thumbnail-img"
                    />
                  </picture>
                </figure>
              </div>
            </div>
          </nav>
        </section>
        <section></section>
      </main>
    </div>

    <Breadcrumb
      currentPageTitle={itemData.name}
      parentPage={{ title: categoryData.title, href: `/${categoryId}/` }}
    />
    <PageBottomWave />
  </section>
</PageLayout>

<style lang="scss">
  @import "../../styles/variables";
  @import "../../styles/functions";
  @import "../../styles/mixins";

  .detail-page {
    padding-top: spx(296);
    position: relative;
    min-height: 90vh;
    padding-bottom: spx(99);
    @include tablet-up {
      padding-top: ppx(253 * 1.2);
      padding-bottom: ppx(228 * 1.2);
    }
    @include desktop-up {
      padding-top: ppx(253);
      padding-bottom: ppx(228);
    }

    &__container {
    }

    &__header {
      text-align: center;
      margin-bottom: spx(60);
      @include tablet-up {
        margin-bottom: ppx(80 * 1.2);
      }
      @include desktop-up {
        margin-bottom: ppx(80);
      }
    }

    &__title {
      color: var(--base_5, #102a4d);
      font-size: spx(60);
      font-style: normal;
      font-weight: 700;
      line-height: 130%;
      text-align: center;
      @include tablet-up {
        font-size: ppx(110 * 1.2);
      }
      @include desktop-up {
        font-size: ppx(110);
      }

      &-accent {
        color: var(--logo_color_3, #c99e2d);
      }
    }

    &__subtitle {
      color: var(--base_5, #102a4d);
      text-align: center;
      font-size: spx(26);
      font-style: normal;
      font-weight: 700;
      line-height: 180%;
      margin-top: spx(10);
      @include tablet-up {
        font-size: ppx(37 * 1.2);
        margin-top: ppx(15 * 1.2);
      }
      @include desktop-up {
        font-size: ppx(37);
        margin-top: ppx(15);
      }
    }

    &__content {
    }
  }

  .detail-content {
    @include tablet-up {
    }
    @include desktop-up {
    }

    &__header {
      @include tablet-up {
      }
      @include desktop-up {
      }
    }

    &__title {
      color: var(--logo_color_3, #c99e2d);
      text-align: center;
      font-family: "Zen Kaku Gothic Antique";
      font-size: spx(40);
      font-style: normal;
      font-weight: 700;
      line-height: 160%;
      letter-spacing: spx(4);
      @include tablet-up {
        font-size: ppx(65 * 1.2);
        line-height: 180%;
        letter-spacing: ppx(6.5 * 1.2);
      }
      @include desktop-up {
        font-size: ppx(65);
        letter-spacing: ppx(6.5);
      }
    }

    &__description {
      color: var(--base_5, #102a4d);
      text-align: center;
      font-family: "Zen Kaku Gothic Antique";
      font-size: spx(28);
      font-style: normal;
      font-weight: 700;
      line-height: 160%;
      margin-top: spx(30);
      width: spx(620);
      margin-inline: auto;
      @include tablet-up {
        font-size: ppx(33 * 1.2);
        margin-top: ppx(40 * 1.2);
        width: ppx(1400 * 1.2);
      }
      @include desktop-up {
        font-size: ppx(33);
        margin-top: ppx(40);
        width: ppx(1400);
      }
    }

    &__media {
      margin-top: spx(30);
      position: relative;
      padding-bottom: spx(150);
      @include tablet-up {
        margin-top: ppx(40 * 1.2);
        padding-bottom: ppx(190 * 1.2);
      }
      @include desktop-up {
        margin-top: ppx(40);
        padding-bottom: ppx(190);
      }
    }

    &__main-image {
      @include tablet-up {
      }
      @include desktop-up {
      }
    }

    &__main-img {
      display: block;
      width: spx(620);
      height: spx(398);
      border-radius: spx(18);
      object-fit: cover;
      @include tablet-up {
        width: ppx(1400 * 1.2);
        height: ppx(900 * 1.2);
        border-radius: ppx(40 * 1.2);
      }
      @include desktop-up {
        width: ppx(1400);
        height: ppx(900);
        border-radius: ppx(40);
      }
    }

    &__thumbnails {
      display: flex;
      justify-content: center;
      align-items: center;
      width: spx(620);
      height: spx(117);
      gap: spx(10);
      flex-wrap: wrap;
      border-radius: spx(17.714);
      background: var(--base_2, #fcf2c9);
      margin-top: spx(20);
      @include tablet-up {
        width: ppx(1400 * 1.2);
        height: ppx(210 * 1.2);
        gap: ppx(15 * 1.2);
        border-radius: ppx(40 * 1.2);
        margin-top: ppx(20 * 1.2);
      }
      @include desktop-up {
        width: ppx(1400);
        height: ppx(210);
        gap: ppx(15);
        border-radius: ppx(40);
        margin-top: ppx(20);
      }
      .swiper-wrapper {
        justify-content: center;
        align-items: center;
        gap: spx(10);
        @include tablet-up {
          gap: ppx(15 * 1.2);
        }
        @include desktop-up {
          gap: ppx(15);
        }
      }

      // Swiperのアクティブサムネイル用スタイル
      .swiper-slide {
        height: max-content;
        &.swiper-slide-thumb-active {
          .detail-content__thumbnail-img {
            opacity: 1;
            transform: scale(1.05);
            transition: all 0.3s ease;
            border: spx(3.1) solid var(--white, #fff);
            @include tablet-up {
              border: ppx(7) * 1.2 solid var(--white, #fff);
            }
            @include desktop-up {
              border: ppx(7) solid var(--white, #fff);
            }
          }
        }
      }
    }

    &__thumbnail {
      @include tablet-up {
      }
      @include desktop-up {
      }
    }

    &__thumbnail-img {
      display: block;
      width: spx(87);
      height: spx(87);
      border-radius: spx(5);
      object-fit: cover;
      opacity: 0.7;
      transition: all 0.3s ease;
      cursor: pointer;

      @include tablet-up {
        width: ppx(170 * 1.2);
        height: ppx(170 * 1.2);
        border-radius: ppx(10 * 1.2);
      }
      @include desktop-up {
        width: ppx(170);
        height: ppx(170);
        border-radius: ppx(10);
      }

      // ホバー時のスタイル
      @include hover {
        &:hover {
          opacity: 0.9;
          transform: scale(1.02);
        }
      }
    }

    // Swiper アクティブスライド用スタイル
    .swiper-slide-active {
      .detail-content__thumbnail {
        @include tablet-up {
        }
        @include desktop-up {
        }
      }

      .detail-content__thumbnail-img {
        @include tablet-up {
        }
        @include desktop-up {
        }
      }
    }

    // カスタムカレントクラス用スタイル
    &__thumbnail--current {
      @include tablet-up {
      }
      @include desktop-up {
      }

      .detail-content__thumbnail-img {
        @include tablet-up {
        }
        @include desktop-up {
        }
      }
    }

    // メインスライダー用Swiper最小限スタイル
    &__main-image.swiper {
      @include tablet-up {
      }
      @include desktop-up {
      }
    }

    &__main-figure {
      @include tablet-up {
      }
      @include desktop-up {
      }
    }

    // サムネイルスライダー用Swiper最小限スタイル
    &__thumbnails.swiper {
      @include tablet-up {
      }
      @include desktop-up {
      }

      // Swiper-slide の幅を制限して横並び表示を実現
      .swiper-slide {
        width: spx(87);
        @include tablet-up {
          width: ppx(170 * 1.2);
        }
        @include desktop-up {
          width: ppx(170);
        }
      }
    }
    .swiper-wrapper {
      width: spx(620);
      margin-inline: auto;
      @include tablet-up {
        width: ppx(1400 * 1.2);
      }
      @include desktop-up {
        width: ppx(1400);
      }
    }
  }
</style>

<script>
  import { Swiper } from "swiper";
  import { EffectFade, Autoplay } from "swiper/modules";
  import "swiper/css";
  import "swiper/css/effect-fade";

  document.addEventListener("DOMContentLoaded", function () {
    // サムネイルスライダーを初期化
    const thumbSwiper = new Swiper("#thumb-swiper", {
      slidesPerView: "auto",
      freeMode: true,
      watchSlidesProgress: true,
    });

    // メインスライダーを初期化
    const mainSwiper = new Swiper("#main-swiper", {
      modules: [EffectFade, Autoplay],
      effect: "fade",
      fadeEffect: {
        crossFade: true,
      },
      autoplay: {
        delay: 5000, // 5秒間隔で自動再生
        disableOnInteraction: false, // ユーザー操作後も自動再生継続
        pauseOnMouseEnter: true, // マウスホバー時は停止
      },
      thumbs: {
        swiper: thumbSwiper,
      },
      on: {
        slideChange: function (swiper) {
          const activeIndex = swiper.activeIndex;
          console.log("Main slide changed to:", activeIndex);
          // 手動でサムネイルのアクティブクラスを管理
          const thumbItems = document.querySelectorAll(
            "#thumb-swiper .swiper-slide",
          );
          thumbItems.forEach((item, index) => {
            if (index === activeIndex) {
              item.classList.add("swiper-slide-thumb-active");
            } else {
              item.classList.remove("swiper-slide-thumb-active");
            }
          });
        },
      },
    });

    // サムネイルクリック時の連動機能を追加
    const thumbnailSlides = document.querySelectorAll(
      "#thumb-swiper .swiper-slide",
    );
    thumbnailSlides.forEach((slide, index) => {
      slide.addEventListener("click", function () {
        // メインスライダーを対応するスライドに移動
        mainSwiper.slideTo(index);

        // サムネイルスライダーも対応するスライドをアクティブに
        thumbSwiper.slideTo(index);

        // クリック時にもアクティブクラス管理
        thumbnailSlides.forEach((thumbItem, thumbIndex) => {
          if (thumbIndex === index) {
            thumbItem.classList.add("swiper-slide-thumb-active");
          } else {
            thumbItem.classList.remove("swiper-slide-thumb-active");
          }
        });
      });
    });

    // 初期状態で最初のサムネイルをアクティブに設定
    if (thumbnailSlides.length > 0) {
      thumbnailSlides[0].classList.add("swiper-slide-thumb-active");
    }
  });
</script>
